name: Nightly Audit

on: 
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  check_redirects_0:
    name: Check redirect 0
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Fetch validator
        run: |
          rm -f ./validator
          curl -s -O "https://raw.githubusercontent.com/SwiftPackageIndex/PackageList-Validator/main/validator"

      - name: Check redirect
        run: |
          chmod +x ./validator
          ./validator --version
          ./validator check-redirects -i packages.json -o out.json --chunk 0 --number-of-chunks 2 --limit 10

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          path: |
            validator
            out.json

  check_redirects_1:
    name: Check redirect 1
    needs: check_redirects_0
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: artifact

      - name: Check redirect
        run: |
          chmod +x ./validator
          ./validator --version
          ./validator check-redirects -i out.json -o out.json --chunk 1 --number-of-chunks 2

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          path: out.json

  check_dependencies_0:
    name: Check dependencies 0
    needs: check_redirects_1
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: artifact

      - name: Check dependencies
        run: |
          chmod +x ./validator
          ./validator --version
          ./validator check-dependencies -i out.json -o out.json --chunk 0 --number-of-chunks 3

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          path: out.json

  check_dependencies_1:
    name: Check dependencies 1
    needs: check_dependencies_0
    runs-on: macos-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: artifact

      - name: Check dependencies
        run: |
          chmod +x ./validator
          ./validator --version
          ./validator check-dependencies -i out.json -o out.json --chunk 1 --number-of-chunks 3

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          path: out.json

  check_dependencies_last:
    name: Check dependencies 2
    needs: check_dependencies_1
    runs-on: macos-latest
    steps:
      # we need to check out the repo in the last step in order to create a PR
      - name: Checkout
        uses: actions/checkout@v2

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: artifact

      - name: Check dependencies
        run: |
          chmod +x ./validator
          ./validator --version
          ./validator check-dependencies -i out.json -o out.json --chunk 2 --number-of-chunks 3

          mv out.json packages.json
          rm validator  # prevent binary from appearing in the PR

      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Updated Packages
          title: '[Nightly] Updated Packages'
          body: |
            :robot: This is an automated change
            
            - Removed any redirects
            - Removed any duplicates
            - Removed any deleted repositories
            - Added any unknown dependencies

      - name: Check outputs
        run: echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
