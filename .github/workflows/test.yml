name: Cache test

on:
  push:
  workflow_dispatch:

#     # - name: Set up cache
#     #   id: packages.json-cache
#     #   uses: actions/cache@v2
#     #   with:
#     #       path: ${{ github.workspace }}/packages.json
#     #       key: ${{ runner.os }}-packages.json


jobs:
  check_redirects:
    name: Check redirect
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      # TODO: remove --limit
      - name: Check redirect
        run: |
          rm -f ./validator
          curl -s -O "https://raw.githubusercontent.com/SwiftPackageIndex/PackageList-Validator/main/validator"
          chmod +x ./validator
          ./validator --version
          ./validator check-redirects -i packages.json -o packages.json --limit 10
          echo
          echo packages.json diff:
          git diff packages.json
      - name: Upload packages.json
        uses: actions/upload-artifact@v3
        with:
          name: packages.json
          path: packages.json

  check_dependencies_0:
    name: Check dependencies batch 0
    needs: check_redirects
    runs-on: macos-latest
    steps:
      - name: Download packages.json
        uses: actions/download-artifact@v3
        with:
          name: packages.json
      # TODO: remove --limit
      - name: Check dependencies
        run: |
          rm -f ./validator
          curl -s -O "https://raw.githubusercontent.com/SwiftPackageIndex/PackageList-Validator/main/validator"
          chmod +x ./validator
          ./validator --version
          ./validator check-dependencies -i packages.json -o packages.json --limit 10
      - name: Upload packages.json
        uses: actions/upload-artifact@v3
        with:
          name: packages.json
          path: packages.json
